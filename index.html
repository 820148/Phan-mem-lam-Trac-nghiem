
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm thi trắc nghiệm</title>

<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: { fontCache: 'global' }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        html, body { margin:0; font-family: Arial, sans-serif; background:#f8f9fa; }
        #setup, #preExam, #examPage { max-width:700px; margin:auto; padding:12px; }
        textarea { width:100%; height:200px; font-size:15px; line-height:1.4; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
        #preExam { text-align:center; padding-top:80px; display:none; }
        #preExam button { font-size:28px; padding:20px 40px; cursor: pointer; }
        #examPage { display:none; }
        .top-bar { display:flex; justify-content:space-between; align-items:center; margin:8px 0; flex-wrap:wrap; position: sticky; top: 0; background: #f8f9fa; z-index: 10; padding: 10px 0; }
        .timer { background:#ffeeba; padding:8px 14px; font-size:26px; font-weight:bold; color:#d00000; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.25); }
        .question { margin-bottom:18px; padding:15px; border-radius:8px; background:#fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .question b { display:block; margin-bottom:10px; font-size: 1.1em; }
        label { display:block; margin-bottom:8px; font-size:15px; cursor: pointer; padding: 5px; border-radius: 4px; }
        label:hover { background: #f0f0f0; }
        .unanswered { border:2px solid red; }
        .correct { border-left: 5px solid #28a745; }
        .wrong { border-left: 5px solid #dc3545; }
        .selected-correct { color:#0a8a2a; font-weight:bold; background: #eaffea; }
        .selected-wrong { color:#c00000; font-weight:bold; background: #ffeaea; }
        .correct-answer { color:green; font-weight:bold; margin-top:10px; padding: 5px; background: #e8f5e9; border-radius: 4px; }
        .score-box { margin-bottom:20px; padding:18px; background:#fff; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.15); text-align:center; }
        .percent { font-size:44px; font-weight:bold; color:#d00000; margin:10px 0; }
        button { padding:10px 18px; margin:6px 4px; font-size:15px; border-radius:6px; cursor:pointer; border:1px solid #ccc; background: #fff; }
        button:hover { background: #eee; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .hidden { display:none; }
    </style>
</head>
<body>

<div id="setup">
    <h2>PHẦN MỀM THI TRẮC NGHIỆM</h2>
    <label>Môn thi:</label>
    <input type="text" id="subject" style="width:100%; padding:8px;" placeholder="Ví dụ: Toán Giải Tích">
    <br><br>
    <label>⏱ Thời gian làm bài (phút):</label>
    <input type="number" id="timeLimit" value="10" min="1" style="padding:8px;">
    <br><br>
    <label>Đề thi (Mỗi câu cách nhau 1 dòng trống):</label>
    <textarea id="inputText" placeholder="Câu 1: ..."></textarea>
    <br>
    <button class="btn-primary" onclick="prepareExam()">Tạo đề thi</button>
</div>

<div id="preExam">
    <h2 id="preSubject"></h2>
    <p id="preTime"></p>
    <button class="btn-primary" onclick="startExam()">Bắt đầu làm bài</button>
</div>

<div id="examPage">
    <div class="top-bar">
        <div>
            <button onclick="checkProgress()">Kiểm tra</button>
            <button class="btn-primary" onclick="submitExam()">Nộp bài</button>
            <button id="backBtn" class="hidden" onclick="goBack()">Làm lại</button>
        </div>
        <div class="timer" id="timer">00:00</div>
    </div>
    <div id="result"></div>
    <div id="exam"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let answers={}, correct={}, optionsStore={}, timeLeft, timerInterval, submitted=false;

function prepareExam(){
    const subject = document.getElementById("subject").value.trim();
    const minutes = parseInt(document.getElementById("timeLimit").value);
    const text = document.getElementById("inputText").value.trim();
    
    if(!subject || !minutes || !text){ alert("Vui lòng nhập đầy đủ thông tin và nội dung đề thi!"); return; }
    
    document.getElementById("setup").style.display="none";
    document.getElementById("preExam").style.display="block";
    document.getElementById("preSubject").innerText = "Môn thi: " + subject;
    document.getElementById("preTime").innerText = "Thời gian làm bài: " + minutes + " phút";
}

function startExam() {
    // 1. Chuyển đổi giao diện
    document.getElementById("preExam").style.display = "none";
    const examPage = document.getElementById("examPage");
    examPage.style.display = "block";

    // 2. Lấy dữ liệu và thiết lập thời gian
    let text = document.getElementById("inputText").value.trim();
    let minutes = parseInt(document.getElementById("timeLimit").value);
    timeLeft = minutes * 60;

    // 3. Tách các câu hỏi (bằng dòng trống)
    const blocks = text.split(/\n\s*\n/);
    let examHtml = "";

    blocks.forEach((block, index) => {
        let lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        let questionLines = [], options = {}, answer = "";

        lines.forEach(line => {
            // Kiểm tra định dạng A. B. C. D.
            if (/^[A-D]\./.test(line)) {
                options[line[0]] = line;
            } else if (line.toLowerCase().startsWith("đáp án")) {
                let parts = line.split(":");
                if (parts[1]) answer = parts[1].trim();
            } else {
                questionLines.push(line);
            }
        });

        // Chỉ tạo câu hỏi nếu có đáp án và ít nhất 2 lựa chọn
        if (!answer || Object.keys(options).length < 2) return;

        correct[index] = answer;
        optionsStore[index] = options;

        let html = `<div class="question" id="q${index}"><b>Câu ${index + 1}: ${questionLines.join("<br>")}</b>`;
        ["A", "B", "C", "D"].forEach(k => {
            if (options[k]) {
                html += `<label><input type="radio" name="q${index}" value="${k}" onchange="answers[${index}]='${k}'"> ${options[k]}</label>`;
            }
        });
        html += "</div>";
        examHtml += html;
    });

    // 4. Đưa nội dung vào trang web
    const examDiv = document.getElementById("exam");
    examDiv.innerHTML = examHtml;

    // 5. Kỹ thuật Render LaTeX an toàn cho GitHub
    if (window.MathJax && MathJax.typesetPromise) {
        // Đợi một khoảng thời gian cực ngắn (0ms) để DOM thực sự cập nhật xong
        setTimeout(() => {
            MathJax.typesetPromise([examDiv])
                .then(() => {
                    console.log("LaTeX đã render thành công!");
                })
                .catch((err) => {
                    console.error("Lỗi MathJax:", err.message);
                    // Nếu lỗi (do script chưa load kịp), thử render lại sau 500ms
                    setTimeout(() => MathJax.typesetPromise(), 500);
                });
        }, 50); 
    } else {
        console.warn("Thư viện MathJax chưa được tải.");
    }

    startTimer();
}function startExam(){
    document.getElementById("preExam").style.display="none";
    document.getElementById("examPage").style.display="block";

    let text = document.getElementById("inputText").value.trim();
function startExam() {
    // 1. Chuyển đổi giao diện
    document.getElementById("preExam").style.display = "none";
    const examPage = document.getElementById("examPage");
    examPage.style.display = "block";

    // 2. Lấy dữ liệu và thiết lập thời gian
    let text = document.getElementById("inputText").value.trim();
    let minutes = parseInt(document.getElementById("timeLimit").value);
    timeLeft = minutes * 60;

    // 3. Tách các câu hỏi (bằng dòng trống)
    const blocks = text.split(/\n\s*\n/);
    let examHtml = "";

    blocks.forEach((block, index) => {
        let lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        let questionLines = [], options = {}, answer = "";

        lines.forEach(line => {
            // Kiểm tra định dạng A. B. C. D.
            if (/^[A-D]\./.test(line)) {
                options[line[0]] = line;
            } else if (line.toLowerCase().startsWith("đáp án")) {
                let parts = line.split(":");
                if (parts[1]) answer = parts[1].trim();
            } else {
                questionLines.push(line);
            }
        });

        // Chỉ tạo câu hỏi nếu có đáp án và ít nhất 2 lựa chọn
        if (!answer || Object.keys(options).length < 2) return;

        correct[index] = answer;
        optionsStore[index] = options;

        let html = `<div class="question" id="q${index}"><b>Câu ${index + 1}: ${questionLines.join("<br>")}</b>`;
        ["A", "B", "C", "D"].forEach(k => {
            if (options[k]) {
                html += `<label><input type="radio" name="q${index}" value="${k}" onchange="answers[${index}]='${k}'"> ${options[k]}</label>`;
            }
        });
        html += "</div>";
        examHtml += html;
    });

    // 4. Đưa nội dung vào trang web
    const examDiv = document.getElementById("exam");
    examDiv.innerHTML = examHtml;

    // 5. Kỹ thuật Render LaTeX an toàn cho GitHub
    if (window.MathJax && MathJax.typesetPromise) {
        // Đợi một khoảng thời gian cực ngắn (0ms) để DOM thực sự cập nhật xong
        setTimeout(() => {
            MathJax.typesetPromise([examDiv])
                .then(() => {
                    console.log("LaTeX đã render thành công!");
                })
                .catch((err) => {
                    console.error("Lỗi MathJax:", err.message);
                    // Nếu lỗi (do script chưa load kịp), thử render lại sau 500ms
                    setTimeout(() => MathJax.typesetPromise(), 500);
                });
        }, 50); 
    } else {
        console.warn("Thư viện MathJax chưa được tải.");
    }

    startTimer();
}

function startTimer(){
    timerInterval = setInterval(() => {
        let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById("timer").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
        if(timeLeft <= 0){ 
            clearInterval(timerInterval); 
            alert("⏰ Hết giờ!"); 
            submitExam(); 
        }
        timeLeft--;
    }, 1000);
}

function checkProgress(){
    let total = Object.keys(correct).length, done = 0;
    for(let i in correct){
        let qDiv = document.getElementById("q" + i);
        if(answers[i]) {
            done++;
            qDiv.classList.remove("unanswered");
        } else {
            qDiv.classList.add("unanswered");
        }
    }
    alert(`Bạn đã hoàn thành: ${done}/${total} câu.`);
}

function submitExam(){
    if(submitted) return;
    submitted = true;
    clearInterval(timerInterval);

    let total = Object.keys(correct).length, score = 0;
    for(let i in correct){
        let qDiv = document.getElementById("q" + i);
        let radios = qDiv.querySelectorAll("input");
        
        radios.forEach(r => {
            r.disabled = true;
            let label = r.parentElement;
            if(r.checked){
                if(r.value === correct[i]) label.classList.add("selected-correct");
                else label.classList.add("selected-wrong");
            }
        });

        if(answers[i] === correct[i]){ 
            score++; 
            qDiv.classList.add("correct"); 
        } else { 
            qDiv.classList.add("wrong"); 
            let correctDiv = document.createElement("div");
            correctDiv.className = "correct-answer";
            correctDiv.innerHTML = `✔ Đáp án đúng: ${optionsStore[i][correct[i]]}`;
            qDiv.appendChild(correctDiv);
        }
    }

    let percent = ((score / total) * 100).toFixed(1);
    document.getElementById("result").innerHTML = `
        <div class="score-box">
            <h2>KẾT QUẢ</h2>
            <div class="percent">${percent}%</div>
            <div>Đúng <b>${score}/${total}</b> câu</div>
        </div>`;
    
    document.getElementById("backBtn").classList.remove("hidden");
    if (window.MathJax) MathJax.typesetPromise();
    window.scrollTo(0,0);
}

function goBack(){ location.reload(); }
</script>
</body>
</html>
