<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm thi tr·∫Øc nghi·ªám - H·ªó tr·ª£ LaTeX ƒë·∫ßy ƒë·ªß</title>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: {'[+]': ['base', 'ams', 'noerrors', 'noundefined']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {load: ['[tex]/ams', '[tex]/noerrors', '[tex]/noundefined']}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        html, body { margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; }
        #setup, #preExam, #examPage { max-width:800px; margin:auto; padding:20px; }
        textarea { width:100%; height:250px; font-size:15px; border-radius: 8px; border: 1px solid #ccc; padding: 12px; box-sizing: border-box; }
        #preExam, #examPage { display:none; }
        .question { margin-bottom:20px; padding:20px; border-radius:10px; background:#fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .question b { display:block; margin-bottom:12px; font-size: 1.15em; color: #1a1a1a; }
        label { display:block; margin: 10px 0; padding: 12px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        label:hover { background: #f8f9fa; border-color: #007bff; }
        .timer { background:#dc3545; color:#fff; padding:10px 20px; font-size:24px; font-weight:bold; border-radius:30px; }
        .top-bar { display:flex; justify-content:space-between; align-items:center; position: sticky; top: 0; background: rgba(240,242,245,0.9); z-index: 100; padding: 10px 0; }
        .correct { border-left: 6px solid #28a745; background: #f4fff4; }
        .wrong { border-left: 6px solid #dc3545; background: #fff4f4; }
        .selected-correct { color:#155724; font-weight:bold; background: #d4edda; }
        .selected-wrong { color:#721c24; font-weight:bold; background: #f8d7da; }
        .correct-answer { color:#28a745; font-weight:bold; margin-top:10px; border-top: 1px dashed #ccc; padding-top: 5px; }
        .btn-primary { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary:hover { background: #0056b3; }
        mjx-container { font-size: 110% !important; }
    </style>
</head>
<body class="tex2jax_process">

<div id="setup">
    <h2>üõ† C·∫§U H√åNH ƒê·ªÄ THI</h2>
    <label>T√™n b√†i thi:</label>
    <input type="text" id="subject" style="width:100%; padding:10px;" placeholder="Nh·∫≠p t√™n m√¥n h·ªçc...">
    <br><br>
    <label>‚è± Th·ªùi gian (ph√∫t):</label>
    <input type="number" id="timeLimit" value="15" style="padding:10px;">
    <br><br>
    <label>N·ªôi dung ƒë·ªÅ thi (D√°n c√¢u h·ªèi c·ªßa b·∫°n v√†o ƒë√¢y):</label>
    <textarea id="inputText" placeholder="C√¢u 1: Di·ªán t√≠ch $24 \text{ cm}^2$ ..."></textarea>
    <br>
    <button class="btn-primary" onclick="prepareExam()">T·∫†O ƒê·ªÄ THI</button>
</div>

<div id="preExam">
    <h2 id="preSubject"></h2>
    <p id="preTime" style="font-size: 1.2em;"></p>
    <button class="btn-primary" style="font-size: 1.5em;" onclick="startExam()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
</div>

<div id="examPage">
    <div class="top-bar">
        <div>
            <button class="btn-primary" onclick="submitExam()">N·ªòP B√ÄI</button>
        </div>
        <div class="timer" id="timer">00:00</div>
    </div>
    <div id="result"></div>
    <div id="exam"></div>
</div>

<script>
let answers={}, correct={}, optionsStore={}, timeLeft, timerInterval, submitted=false;

function prepareExam(){
    const subject = document.getElementById("subject").value.trim() || "B√†i thi tr·∫Øc nghi·ªám";
    const minutes = parseInt(document.getElementById("timeLimit").value);
    const text = document.getElementById("inputText").value.trim();
    if(!text){ alert("Vui l√≤ng nh·∫≠p ƒë·ªÅ thi!"); return; }
    document.getElementById("setup").style.display="none";
    document.getElementById("preExam").style.display="block";
    document.getElementById("preSubject").innerText = subject;
    document.getElementById("preTime").innerText = "Th·ªùi gian: " + minutes + " ph√∫t";
}

function startExam() {
    document.getElementById("preExam").style.display = "none";
    document.getElementById("examPage").style.display = "block";
    let text = document.getElementById("inputText").value.trim();
    timeLeft = parseInt(document.getElementById("timeLimit").value) * 60;

    const blocks = text.split(/\n\s*\n/);
    let examHtml = "";

    blocks.forEach((block, index) => {
        let lines = block.split("\n").map(l => l.trim()).filter(Boolean);
        let questionLines = [], options = {}, answerFound = "";

        lines.forEach(line => {
            if (/^[A-D]\./i.test(line)) {
                let label = line[0].toUpperCase();
                options[label] = line;
            } else if (line.toLowerCase().includes("ƒë√°p √°n")) {
                let parts = line.split(":");
                if (parts[1]) answerFound = parts[1].trim().toUpperCase().charAt(0);
            } else {
                questionLines.push(line);
            }
        });

        if (!answerFound) return;

        correct[index] = answerFound;
        optionsStore[index] = options;

        let html = `<div class="question" id="q${index}"><b>${questionLines.join("<br>")}</b>`;
        ["A", "B", "C", "D"].forEach(k => {
            if (options[k]) {
                html += `<label><input type="radio" name="q${index}" value="${k}" onchange="answers[${index}]='${k}'"> ${options[k]}</label>`;
            }
        });
        html += "</div>";
        examHtml += html;
    });

    const examDiv = document.getElementById("exam");
    examDiv.innerHTML = examHtml;

    // K√≠ch ho·∫°t MathJax render
    if (window.MathJax) {
        setTimeout(() => {
            MathJax.typesetPromise([examDiv]).catch(err => console.log(err));
        }, 100);
    }
    startTimer();
}

function startTimer(){
    timerInterval = setInterval(() => {
        let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        document.getElementById("timer").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
        if(timeLeft <= 0){ clearInterval(timerInterval); submitExam(); }
        timeLeft--;
    }, 1000);
}

function submitExam(){
    if(submitted) return;
    submitted = true;
    clearInterval(timerInterval);
    let total = Object.keys(correct).length, score = 0;
    
    for(let i in correct){
        let qDiv = document.getElementById("q" + i);
        let selected = answers[i];
        
        if(selected === correct[i]){
            score++;
            qDiv.classList.add("correct");
        } else {
            qDiv.classList.add("wrong");
            let div = document.createElement("div");
            div.className = "correct-answer";
            div.innerHTML = "‚úî ƒê√°p √°n ƒë√∫ng: " + (optionsStore[i][correct[i]] || correct[i]);
            qDiv.appendChild(div);
        }

        qDiv.querySelectorAll("input").forEach(input => {
            input.disabled = true;
            if(input.value === selected){
                input.parentElement.classList.add(selected === correct[i] ? "selected-correct" : "selected-wrong");
            }
        });
    }

    let percent = ((score / total) * 100).toFixed(1);
    document.getElementById("result").innerHTML = `
        <div style="background:#fff; padding:20px; border-radius:10px; text-align:center; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin:0">K·∫æT QU·∫¢</h2>
            <div style="font-size:40px; color:#dc3545; font-weight:bold;">${percent}%</div>
            <p>ƒê√∫ng ${score}/${total} c√¢u</p>
            <button class="btn-primary" onclick="location.reload()">L√ÄM ƒê·ªÄ KH√ÅC</button>
        </div>`;
    
    if (window.MathJax) MathJax.typesetPromise();
    window.scrollTo(0,0);
}
</script>
</body>
</html>
